<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registered Staffs</title>
  <link rel="icon" type="image/x-icon" href="../image/favicon/favicon.ico">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4e73df;
      --secondary-color: #224abe;
      --success-color: #1cc88a;
      --danger-color: #e74a3b;
      --warning-color: #f6c23e;
      --info-color: #36b9cc;
      --light-bg: #f8f9fc;
      --dark-text: #5a5c69;
    }
    
    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Sidebar styles */
    .sidebar {
      width: 250px;
      min-height: 100vh;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      padding: 2rem 1rem;
    }
    .sidebar .navbar-brand {
      font-weight: 700;
      letter-spacing: 1px;
      color: #fff;
      margin-bottom: 2rem;
      display: block;
      text-align: left;
    }
    .sidebar .nav-link {
      color: #fff;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }
    .sidebar .nav-link.active,
    .sidebar .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .main-container {
      margin-top: 20px;
      padding: 20px;
    }
    
    .card {
      border-radius: 10px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      margin-bottom: 20px;
      border: none;
    }
    
    .card-header {
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border-radius: 10px 10px 0 0 !important;
      font-weight: 600;
    }
    
    .table {
      width: 100%;
      margin-bottom: 0;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .table th, .table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    
    .table th {
      background-color: #f8f9fc;
      color: var(--dark-text);
      font-weight: 600;
    }
    
    .table tbody tr:hover {
      background-color: #f1f1f1;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: 600;
    }
    
    .btn-primary:hover {
      background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      color: var(--dark-text);
      font-size: 0.9rem;
      margin-top: 30px;
    }
    
    .accordion-button {
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      font-weight: 600;
      border-radius: 5px;
    }
    
    .accordion-button:not(.collapsed) {
      background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
      color: white;
    }
    
    .accordion-button:focus {
      box-shadow: none;
      border-color: rgba(0, 0, 0, 0.125);
    }
    
    .accordion-item {
      border: none;
      margin-bottom: 10px;
      border-radius: 10px;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="sidebar flex-shrink-0">
      <a class="navbar-brand" href="#"><i class="fas fa-camera-retro me-2"></i> Face Recognition Attendance</a>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}"><i class="fas fa-home me-2"></i> Home</a></li>
        <li><a class="nav-link" href="{{ url_for('register_page') }}"><i class="fas fa-user-plus me-2"></i> Register</a></li>
        <li><a class="nav-link" href="{{ url_for('admin_register_page') }}"><i class="fas fa-user-shield me-2"></i> Admin Register</a></li>
        <li><a class="nav-link" href="{{ url_for('attendance') }}"><i class="fas fa-chart-bar me-2"></i> Attendance</a></li>
        <li><a class="nav-link" href="{{ url_for('notifications') }}"><i class="fas fa-bell me-2"></i> Notifications</a></li>
        <li><a class="nav-link active" href="#"><i class="fas fa-users me-2"></i> Registered Staffs</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div class="flex-grow-1">
      <div class="container main-container">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-users me-2"></i> Registered Staffs
          </div>
          <div class="card-body">
            <!-- Accordion for Department Sections -->
            <div class="accordion" id="departmentAccordion">
              {% set departments = ['Admin', 'HR', 'Director', 'Janitor', 'Guard'] %}
              {% for dept in departments %}
                {% set dept_staff = students | selectattr('department', 'equalto', dept) | list %}
                {% if dept_staff %}
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ dept }}">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ dept }}" aria-expanded="false" aria-controls="collapse{{ dept }}">
                        <i class="fas fa-users me-2"></i> {{ dept }} Staff ({{ dept_staff | length }})
                      </button>
                    </h2>
                    <div id="collapse{{ dept }}" class="accordion-collapse collapse" aria-labelledby="heading{{ dept }}" data-bs-parent="#departmentAccordion">
                      <div class="accordion-body">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>ID</th>
                              <th>Name</th>
                              <th>Email</th>
                              <th>Phone</th>
                              <th>Department</th>
                              <th>Timestamp</th>
                              <th>Admin Name</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for s in dept_staff %}
                              <tr>
                                <td>{{ s.student_id | default('Unknown') }}</td>
                                <td>{{ s.name | default('Unknown') }}</td>
                                <td>{{ s.email | default('') }}</td>
                                <td>{{ s.phone | default('') }}</td>
                                <td>{{ s.department | default('') }}</td>
                                <td>{{ s.timestamp | datetimeformat | default('') }}</td>
                                <td>{{ s.admin_name | default('Unknown') }}</td>
                                <td>
                                  <button class="btn btn-danger btn-sm fire-btn" data-student-id="{{ s.student_id }}">Fire</button>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}

              <!-- Others Section for Unknown/Missing Departments -->
              {% set others = students | rejectattr('department', 'in', departments) | list %}
              {% if others %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingOthers">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOthers" aria-expanded="false" aria-controls="collapseOthers">
                      <i class="fas fa-users me-2"></i> Others ({{ others | length }})
                    </button>
                  </h2>
                  <div id="collapseOthers" class="accordion-collapse collapse" aria-labelledby="headingOthers" data-bs-parent="#departmentAccordion">
                    <div class="accordion-body">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Department</th>
                            <th>Timestamp</th>
                            <th>Admin Name</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for s in others %}
                            <tr>
                              <td>{{ s.student_id | default('Unknown') }}</td>
                              <td>{{ s.name | default('Unknown') }}</td>
                              <td>{{ s.email | default('') }}</td>
                              <td>{{ s.phone | default('') }}</td>
                              <td>{{ s.department | default('None') }}</td>
                              <td>{{ s.timestamp | datetimeformat | default('') }}</td>
                              <td>{{ s.admin_name | default('Unknown') }}</td>
                              <td>
                                <button class="btn btn-danger btn-sm fire-btn" data-student-id="{{ s.student_id }}">Fire</button>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>

            <!-- Fired Staff Section -->
            <h4 class="mt-4">Fired Staff</h4>
            {% if fired %}
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Department</th>
                    <th>Fired By</th>
                    <th>Fired On</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in fired %}
                    <tr>
                      <td>{{ s.student_id | default('Unknown') }}</td>
                      <td>{{ s.name | default('Unknown') }}</td>
                      <td>{{ s.email | default('') }}</td>
                      <td>{{ s.phone | default('') }}</td>
                      <td>{{ s.department | default('') }}</td>
                      <td>{{ s.fired_by | default('Unknown') }}</td>
                      <td>{{ s.fired_timestamp | datetimeformat | default('Unknown') }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p>No staff have been fired.</p>
            {% endif %}

            <a href="{{ url_for('home') }}" class="btn btn-primary mt-3">
              <i class="fas fa-arrow-left me-2"></i> Back to Home
            </a>
          </div>
        </div>
      </div>

      <!-- Fire Confirmation Modal -->
      <div class="modal fade" id="fireModal" tabindex="-1" aria-labelledby="fireModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="fireModalLabel">Confirm Firing Staff</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Enter your admin password to confirm firing this staff member.</p>
              <input type="password" class="form-control" id="firePassword" placeholder="Password" required>
              <input type="hidden" id="fireStudentId">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmFire">Fire</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>© 2023 Face Recognition Attendance System | Developed with <i class="fas fa-heart text-danger"></i></p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.querySelectorAll('.fire-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.getElementById('fireStudentId').value = this.dataset.studentId;
        new bootstrap.Modal(document.getElementById('fireModal')).show();
      });
    });

    document.getElementById('confirmFire').addEventListener('click', function() {
      const password = document.getElementById('firePassword').value;
      const studentId = document.getElementById('fireStudentId').value;
      if (!password) {
        alert('Password is required');
        return;
      }
      fetch('/fire_staff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id: studentId, password: password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          location.reload();
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('Error: ' + err);
      });
    });
  </script>
</body>
</html>